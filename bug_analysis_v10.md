# バグ分析レポート v10

## 発見された不具合

### 不具合1: 自動割り当て時に既存の利用者が消える

**現象:**
1. 自動割り当てを実行して利用者を車両に割り当てる
2. 数名（例: 2名）を未割り当てリストに戻す
3. 再度「自動割り当て」ボタンを押す
4. **結果**: 戻した2名だけが振り分けられ、それ以前に割り当てられていた利用者が全員消える

**原因分析:**
`handleAutoAssign` 関数（App.jsx 109-199行目）を確認したところ、以下の問題が見つかりました:

```javascript
// 各車両の便をリセット (138-140行目)
activeVehicles.forEach(vehicle => {
  newAssignments[vehicle.id] = { trips: [] }  // ← ここで既存の割り当てを完全にリセット
})
```

**問題点:**
- 自動割り当てを実行するたびに、**既存の割り当てを完全にリセット**している
- その後、**未割り当てリストにいる利用者だけ**を割り当てている
- すでに車両に割り当てられている利用者は考慮されていない

**期待される動作:**
- 既存の割り当てを保持したまま、未割り当てリストの利用者だけを追加で割り当てる
- または、「全リセット」ボタンと「追加割り当て」ボタンを分ける

### 不具合2: ドロップゾーンの範囲が狭く、ドロップに失敗すると利用者が消える

**現象:**
1. 利用者をドラッグする
2. ドロップゾーン（青くなる範囲）が狭くてなかなか青くならない
3. 号車によっては青くならない場合がある
4. **結果**: 青くならずにドロップすると利用者が消えてしまう

**原因分析:**
1. **ドロップゾーンの範囲が狭い**
   - TripManager.jsx や DashboardView.jsx のドロップゾーンが、便のカード内部に限定されている
   - 便が空の場合、ドロップゾーンが非常に小さくなる

2. **ドロップ失敗時の処理がない**
   - App.jsx の `handleDragEnd` 関数で、ドロップ先が見つからない場合の処理が不十分
   - ドロップに失敗した場合、利用者が元の場所に戻らず消えてしまう可能性がある

## 修正方針

### 修正1: 自動割り当てを「追加割り当て」モードに変更

**オプションA: 既存の割り当てを保持する（推奨）**
- 既存の割り当てを保持したまま、未割り当てリストの利用者だけを追加で割り当てる
- 「全リセット」ボタンで既存の割り当てをクリアできる

**オプションB: 確認ダイアログを追加**
- 自動割り当てを実行する前に、「既存の割り当てをリセットしますか?」と確認する
- ユーザーが選択できるようにする

**実装方針:**
オプションAを採用し、以下のように修正します:
1. 自動割り当て時に既存の割り当てをリセットしない
2. 既存の車両の利用者を取得して、空き容量を計算する
3. 未割り当てリストの利用者を空き容量に割り当てる

### 修正2: ドロップゾーンの範囲を拡大し、ドロップ失敗時の安全性を向上

**修正内容:**
1. **ドロップゾーンの範囲を拡大**
   - 便のカード全体をドロップゾーンにする
   - 便が空の場合でも、十分な高さを確保する（min-height を増やす）
   - 車両のカード全体をドロップゾーンにする（どこにドロップしても最後の便に追加される）

2. **ドロップ失敗時の処理を追加**
   - `handleDragEnd` 関数で、ドロップ先が見つからない場合は元の場所に戻す
   - ドロップ失敗時にアラートを表示する

3. **視覚的なフィードバックを改善**
   - ドロップゾーンが青くなる範囲を広げる
   - ドラッグ中に「ここにドロップできます」というメッセージを表示する

## 次のステップ

1. 自動割り当て関数を修正（既存の割り当てを保持）
2. ドロップゾーンの範囲を拡大
3. ドロップ失敗時の処理を追加
4. 動作確認とテスト
5. 最終レポートの作成

