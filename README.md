# デイサービス送迎計画アプリケーション - モバイルビュー機能

## 1. 概要

このドキュメントでは、デイサービス送迎計画アプリケーションに新たに追加された**モバイルビュー機能**と**QRコード連携機能**について詳述します。この機能は、送迎業務のDX（デジタルトランスフォーメーション）を推進し、従来の紙ベースの指示書から、スマートフォンやタブレットでリアルタイムに運行情報を確認できる最新のワークフローへと移行させることを目的としています。

ドライバーは、各車両に割り当てられたQRコードをスキャンするだけで、担当する便の利用者リスト、送迎順序、住所、地図情報に即座にアクセスできます。これにより、ペーパーレス化の実現、情報伝達の迅速化、そしてヒューマンエラーの削減が期待できます。

## 2. 主な機能

### 2.1. モバイル最適化されたドライバー専用ビュー

- **URL**: `/mobile.html?vehicle={車両ID}&day={曜日}&trip={便番号}`
- スマートフォンやタブレットの画面サイズに最適化された、シンプルで視認性の高いインターフェースを提供します。
- ドライバーは、担当する車両、曜日、便に応じた運行指示を直感的に確認できます。

| 機能 | 説明 |
| :--- | :--- |
| **車両・ドライバー情報** | 画面上部に担当車両名、ドライバー名、運行日が表示されます。 |
| **運行サマリー** | 総利用者数、車椅子利用者数、総便数などのサマリー情報を確認できます。 |
| **利用者リスト** | 送迎順にソートされた利用者の一覧が表示されます。各利用者には、名前、乗車予定時刻、車椅子の要否、特記事項が表示されます。 |
| **ナビゲーション連携** | 各利用者の住所をワンタップでGoogle Mapsなどの地図アプリで開くことができます。 |
| **住所コピー機能** | 住所をクリップボードにコピーして、他のナビアプリに手動で貼り付けることも可能です。 |
| **全住所一括コピー** | カーナビ向けに、その日の全送迎先住所を特定のフォーマットで一括コピーする機能です。 |
| **施設への帰還ルート** | 全ての送迎が完了した後、施設へ戻るためのルートを地図アプリで開くことができます。 |

### 2.2. QRコードによる簡単アクセス

- メインの管理画面から、各車両・各便専用のQRコードをモーダルウィンドウで表示できます。
- このQRコードを印刷して車両に掲示しておくことで、ドライバーは自身のスマートフォンでスキャンするだけで、担当便のモバイルビューに直接アクセスできます。
- QRコードには、車両ID、曜日、便番号を含むURLがエンコードされています。

| 機能 | 説明 |
| :--- | :--- |
| **QRコード生成** | `qrcode.react`ライブラリを使用し、動的にQRコードを生成します。 |
| **URLコピー** | モバイルビューのURLをクリップボードにコピーできます。 |
| **QRコード保存** | 表示されているQRコードをPNG画像としてダウンロードできます。 |

## 3. 実装詳細

### 3.1. フロントエンド

- **フレームワーク**: React (Vite)
- **UIコンポーネント**: Shadcn/UI, Lucide Icons
- **QRコード生成**: `qrcode.react`

#### 3.1.1. 新規作成されたコンポーネント

- `src/MobilePage.jsx`: モバイルビュー専用のルートページです。URLパラメータを解釈し、ローカルストレージから該当する運行データを読み込みます。
- `src/components/MobileDriverView.jsx`: モバイルビューのメインUIコンポーネントです。ドライバーに必要な情報を整理して表示します。
- `src/components/VehicleQRCode.jsx`: QRコードの表示と、それに関連するアクション（URLコピー、画像保存）を提供するモーダルコンポーネントです。

#### 3.1.2. ビルド設定の変更

- `vite.config.js`を更新し、`mobile.html`を新しいエントリーポイントとして追加しました。これにより、メインの管理画面とは別に、モバイル専用のページをビルドできるようになりました。

```javascript
// vite.config.js

build: {
  rollupOptions: {
    input: {
      main: resolve(__dirname, 'index.html'),
      mobile: resolve(__dirname, 'mobile.html'),
    },
  },
},
```

### 3.2. データフロー

1.  **データ保存**: メインの管理画面（`App.jsx`）で利用者の割り当てが変更されるたびに、`useEffect`フックがトリガーされます。現在の割り当て状況（`vehicleAssignments`）は、曜日と便名をキーとしてローカルストレージに保存されます。

    ```javascript
    // App.jsx
    const tripStorageKey = `transport-${selectedWeekday}-${selectedTrip}`;
    localStorage.setItem(tripStorageKey, JSON.stringify(tripDataToSave));
    ```

2.  **データ読み込み**: ドライバーがモバイルビューのURLにアクセスすると、`MobilePage.jsx`がマウントされます。`useEffect`内でURLパラメータ（`vehicle`, `day`, `trip`）を読み取り、対応するキーでローカルストレージから運行データを取得します。

    ```javascript
    // MobilePage.jsx
    const storageKey = `transport-${day}-${tripName}`;
    const savedData = localStorage.getItem(storageKey);
    ```

3.  **データ表示**: 取得した車両データは`MobileDriverView.jsx`コンポーネントに渡され、画面にレンダリングされます。

## 4. スクリーンショット

### QRコード表示モーダル

メイン画面で「QRコード」ボタンをクリックすると、以下のモーダルが表示されます。

![QR Code Modal](https://i.imgur.com/example-qr.png)  <!-- この部分は実際のスクリーンショットURLに置き換えてください -->

### モバイルドライバービュー

スマートフォンでQRコードを読み取ると、以下の専用画面にアクセスできます。

![Mobile Driver View](https://i.imgur.com/example-mobile.png) <!-- この部分は実際のスクリーンショットURLに置き換えてください -->

## 5. 今後の展望

- **オフライン対応**: Service Workerを導入し、一度読み込んだ運行情報をオフラインでも表示できるようにします。
- **リアルタイム更新**: WebSocketなどを利用して、管理画面での変更がリアルタイムにドライバーのモバイルビューに反映される仕組みを検討します。
- **完了報告機能**: ドライバーが各利用者の送迎を完了した際に、チェックボタンをタップしてステータスを更新し、管理画面に送信する機能を追加します。

