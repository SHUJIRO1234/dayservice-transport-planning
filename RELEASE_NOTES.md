# デイサービス送迎計画アプリ - 修正リリースノート

## リリース日
2025年10月19日

## 概要
ユーザーからの報告に基づき、複数の重要なバグを修正し、使いやすさを向上させる機能改善を実施しました。

## 修正内容

### 1. ルート最適化機能の修正

**問題:** 車両ごとの「ルート最適化」ボタンをクリックしても反応がなく、距離と時間が計算されない問題がありました。

**原因:** `optimizeRoute`関数と`recalculateRoute`関数の呼び出し時に、引数の順序が関数定義と一致していませんでした。また、戻り値のプロパティ名も正しく参照されていませんでした。

**修正内容:**
- 関数呼び出しの引数順序を修正: `optimizeRoute(users, facility)` → `optimizeRoute(facility, users)`
- 戻り値のプロパティを修正: `result.route` → `result.order`（利用者オブジェクトの配列）
- 距離と時間のプロパティを修正: `result.distance` → `result.totalDistance`、`result.duration` → `result.estimatedTime`

**効果:** ルート最適化ボタンをクリックすると、利用者の訪問順序が最適化され、距離と時間が正しく計算されるようになりました。

### 2. ドラッグ&ドロップ機能の改善

**問題:** 車両から未割り当てリストへ利用者をドラッグ&ドロップしても、元の位置に戻ってしまい、正しく移動できない問題がありました。

**原因:** Reactの状態更新が非同期であるため、同じ関数内で`setUnassignedUsers`を複数回呼び出すと、最初の更新が反映される前に2回目の更新が実行され、古い状態を参照してしまう問題がありました。

**修正内容:**
- 関数型状態更新を使用: `setUnassignedUsers([...unassignedUsers, draggedUser])` → `setUnassignedUsers(prev => [...prev, draggedUser])`
- 未割り当てリストに`UnassignedDropZone`コンポーネントを追加し、`useDroppable`フックでドロップゾーンを設定

**効果:** 車両から未割り当てリストへのドラッグ&ドロップが正常に動作するようになりました。

### 3. 車両間移動機能の実装

**問題:** 利用者を1号車から3号車へ直接移動させることができませんでした。

**修正内容:**
- 各車両タブに`useDroppable`フックを使用してドロップゾーンを追加
- ドラッグオーバー時に緑色のハイライト表示を追加し、視覚的フィードバックを提供
- `id: 'vehicle-${vehicle.id}'`で各車両タブを識別

**効果:** 利用者カードを車両タブに直接ドラッグ&ドロップすることで、車両間の移動が簡単にできるようになりました。

### 4. 便ごとの移動時間表示機能

**状態:** この機能は既に実装されていましたが、ルート最適化の修正により正しく動作するようになりました。

**表示内容:** 各便に「利用者数 / 距離: XX.XX km / 時間: XX分」と表示され、ルート最適化後に自動的に更新されます。

### 5. UIレイアウトの改善

**問題:** 画面上部の未割り当てリストから下部の車両リストへのドラッグ操作がしにくい状況でした。

**修正内容:**
- レイアウトを左右配置に変更: 未割り当てリスト（左側1カラム）、送迎車別管理（右側2カラム）
- レスポンシブ対応を削除し、常に左右配置を維持

**効果:** ドラッグ&ドロップの操作性が大幅に向上し、利用者の割り当て作業がスムーズになりました。

## 技術的な詳細

### 変更されたファイル
1. `transport-web/src/App.jsx`
   - `handleDragEnd`関数の状態管理を改善
   - `handleOptimizeVehicleRoute`関数の引数と戻り値を修正
   - `handleOptimizeAllRoutes`関数の引数と戻り値を修正
   - UIレイアウトのグリッドクラスを変更

2. `transport-web/src/components/VehicleTabs.jsx`
   - `useDroppable`フックをインポート
   - `VehicleTab`コンポーネントにドロップゾーンを追加
   - ドラッグオーバー時のスタイルを追加

### 依存関係
- @dnd-kit/core: 6.3.1（変更なし）
- @dnd-kit/sortable: 9.0.0（変更なし）

## テスト結果

### ローカル環境でのテスト
- ✅ 自動割り当て機能: 正常に動作
- ✅ ルート最適化機能: 距離と時間が正しく計算される
- ✅ ドラッグ&ドロップ: 未割り当て↔車両、車両↔車両の移動が可能
- ✅ UIレイアウト: 左右配置で操作性が向上

### プレビュー環境でのテスト
- ✅ すべての機能が正常に動作することを確認

## 今後の改善予定

以下の機能は今後の開発で検討します:
- 地図表示機能の強化（Googleマップ連携）
- ルート最適化アルゴリズムの改善
- 利用者の詳細情報編集機能
- 送迎計画の保存と読み込み機能
- 印刷機能の追加

## デプロイ方法

1. GitHubリポジトリに変更をプッシュ
2. アプリケーションをビルド: `pnpm run build`
3. Manus Spaceの「公開」ボタンをクリックしてデプロイ

## サポート

問題や質問がある場合は、GitHubのIssuesセクションで報告してください。

