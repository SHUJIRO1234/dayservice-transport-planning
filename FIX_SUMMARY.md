# 利用者マスタ統合問題の修正サマリー

## 修正日時
2025年11月3日

## 問題の概要

利用者マスタから同期した新規利用者が、以下の機能で正しく扱われていませんでした：

1. **曜日タブの人数カウント**: サンプルデータのみをカウントし、新規利用者が含まれていない
2. **全リセット機能**: サンプルデータのみを復元し、新規利用者が消えてしまう
3. **自動割り当て後**: 新規利用者が消えてしまう

## 根本原因

システムには2つの異なるデータソースがあり、それらが適切に統合されていませんでした：

- **サンプルデータ** (`weeklyData`): ハードコードされた30名の利用者
- **利用者マスタデータ** (`localStorage`): 新規登録した利用者

多くの機能が `weeklyData` のみを参照しており、`integrateUserData()` 関数で統合されたデータを使用していませんでした。

## 修正内容

### 1. 曜日タブの人数カウント（Line 823-824）

**修正前:**
```jsx
<Badge variant="secondary" className="ml-2">
  {weeklyData[day]?.length || 0}名
</Badge>
```

**修正後:**
```jsx
<Badge variant="secondary" className="ml-2">
  {integrateUserData(weeklyData)[day]?.length || 0}名
</Badge>
```

**効果:**
- 曜日タブに表示される人数が、サンプルデータと利用者マスタデータの合計を正しく表示するようになります
- 例: 月曜日のサンプルデータ30名 + 新規利用者2名 = 32名と表示される

### 2. 全リセット機能（Line 288-290）

**修正前:**
```jsx
const handleResetAll = () => {
  const users = weeklyData[selectedWeekday] || []
```

**修正後:**
```jsx
const handleResetAll = () => {
  const integratedWeeklyData = integrateUserData(weeklyData)
  const users = integratedWeeklyData[selectedWeekday] || []
```

**効果:**
- 全リセット実行時に、サンプルデータと利用者マスタデータの両方が未割り当てリストに復元されます
- 新規登録した利用者が消えなくなります

## 修正されなかった問題

### 自動割り当て後に新規利用者が消える問題

この問題は、自動割り当てロジック自体の問題ではなく、データの永続化に関する問題である可能性があります。

**考えられる原因:**
1. 自動割り当て後のデータ保存処理が正しく動作していない
2. `vehicleAssignments` の更新時に新規利用者のデータが失われている

**今後の対応:**
- この問題は別途調査が必要です
- 自動割り当てロジック（`handleAutoAssign` 関数）を詳細に確認する必要があります

## テスト方法

### 1. 曜日タブの人数カウント確認

1. 利用者管理画面で新規利用者を登録（例: 月曜日と土曜日）
2. 送迎計画画面に戻る
3. 月曜日タブと土曜日タブの人数を確認
4. **期待される結果**: 
   - 月曜日: サンプルデータ30名 + 新規利用者 = 31名以上
   - 土曜日: サンプルデータ0名 + 新規利用者 = 1名以上

### 2. 全リセット機能確認

1. 利用者管理画面で新規利用者を登録
2. 送迎計画画面で「利用者マスタから同期」をクリック
3. 新規利用者が未割り当てリストに表示されることを確認
4. 「全リセット」をクリック
5. **期待される結果**: 新規利用者が未割り当てリストに残っている

### 3. 自動割り当て機能確認（要追加調査）

1. 利用者管理画面で新規利用者を登録
2. 送迎計画画面で「利用者マスタから同期」をクリック
3. 「自動割り当て」をクリック
4. **期待される結果**: 新規利用者が送迎車に割り当てられる
5. **現在の問題**: 新規利用者が消えてしまう（要修正）

## デプロイ情報

- **コミットハッシュ**: df110b2
- **ブランチ**: master
- **デプロイ先**: https://transport-web-ten.vercel.app/
- **デプロイ方法**: Git push後、Vercelが自動デプロイ

## 確認事項

Vercelのデプロイには数分かかる場合があります。以下の方法で確認してください：

1. ブラウザのキャッシュをクリア（Ctrl+Shift+R または Cmd+Shift+R）
2. 本番環境にアクセス: https://transport-web-ten.vercel.app/
3. 曜日タブの人数を確認
4. 新規利用者を登録してテスト

## 次のステップ

1. ✅ 曜日タブの人数カウント修正 - **完了**
2. ✅ 全リセット機能修正 - **完了**
3. ⏳ 自動割り当て機能の問題調査 - **要対応**
4. ⏳ 本番環境での動作確認 - **ユーザー確認待ち**

