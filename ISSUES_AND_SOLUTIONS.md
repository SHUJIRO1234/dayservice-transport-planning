# デイサービス送迎計画アプリケーション - 問題点と解決策

## 報告された問題点

### 🔴 問題1: 新規登録後に未割り当てに反映されない
**症状:**
- 利用者管理で新規登録した利用者が、該当曜日の未割り当てリストに表示されない
- 利用者管理の一覧には表示される

**原因（推測）:**
1. 本番環境のdays_of_week形式の不一致（「木」vs「木曜日」）
2. 統合処理のタイミング問題
3. カスタムイベントが正しく発火していない

**ユーザーからの提案:**
> 利用者管理で新規利用者は保存されて一覧になるので、未割り当てに展開とかそれも個別や一括や選択ででるようにしたらいいのかな？

### 🟡 問題2: 地図表示で番号が重複表示される
**症状:**
- 車両間で利用者を移動した後、最適化して地図表示すると以前の番号が薄く残る
- 例: 1番の人を入れ替えると、1番が二つ表示される

**原因（推測）:**
- 地図マーカーの削除処理が不完全
- 最適化後のマーカー再描画時に古いマーカーがクリアされていない

### 🟠 問題3: 車両間移動時の定員オーバー制限
**症状:**
- 車両の定員がいっぱいの場合、定員オーバーの表示が出て入れ替えられない
- 一度未割り当てに戻してから再配置する必要があり、手間がかかる

**ユーザーからのフィードバック:**
> この場合は未割り当てに一度落としてからまた置くことで少し手間

## 解決策の提案

### 問題1の解決策: 新規登録後の未割り当て反映

#### 🎯 推奨案: 自動反映 + 手動同期ボタン（ハイブリッド方式）

**実装内容:**
1. **自動反映（基本動作）**
   - 新規登録時に自動的に未割り当てリストに追加
   - リアルタイム更新（既に実装済み）

2. **手動同期ボタン（バックアップ）**
   - 送迎計画画面に「利用者マスタから同期」ボタンを追加
   - クリックすると、利用者マスタの全データを再読み込み
   - 新規利用者を未割り当てリストに追加

3. **視覚的フィードバック**
   - 新規登録後に「○○さんを未割り当てリストに追加しました」とトースト通知
   - 未割り当てリストの該当利用者をハイライト表示（3秒間）

**メリット:**
- ✅ 自動反映が失敗しても手動で同期できる
- ✅ ユーザーが明示的に同期できる安心感
- ✅ シンプルで直感的

**デメリット:**
- ボタンが1つ増える（UI上の複雑さ）

#### 代替案1: 完全自動反映のみ

**実装内容:**
- 新規登録時に必ず未割り当てリストに追加
- days_of_week形式の問題を完全に解決

**メリット:**
- ✅ 最もシンプル
- ✅ ボタン不要

**デメリット:**
- ❌ 自動反映が失敗した場合の対処法がない

#### 代替案2: 利用者管理画面に「送迎計画に追加」ボタン

**実装内容:**
- 利用者管理の各利用者に「送迎計画に追加」ボタン
- 一括選択 + 「選択した利用者を追加」ボタン

**メリット:**
- ✅ ユーザーが明示的にコントロールできる
- ✅ 誤追加を防げる

**デメリット:**
- ❌ 毎回手動で追加する必要がある
- ❌ 手間が増える

### 問題2の解決策: 地図表示の番号重複

#### 🎯 推奨案: マーカー完全クリア + 再描画

**実装内容:**
1. 最適化実行時に全マーカーを削除
2. 新しいルートデータで全マーカーを再描画
3. マーカーのキー管理を改善（React keyまたはマーカーID）

**実装箇所:**
- 地図表示コンポーネント（MapView.jsx または類似ファイル）
- 最適化処理後のマーカー更新ロジック

### 問題3の解決策: 車両間移動時の定員オーバー

#### 🎯 推奨案: スワップ機能（入れ替え）

**実装内容:**
1. **ドラッグ&ドロップでの自動スワップ**
   - 定員オーバーになる場合、ドロップ先の最後の利用者を自動的に元の車両に移動
   - 確認ダイアログ: 「○○さんと△△さんを入れ替えますか？」

2. **スワップモード**
   - 「入れ替えモード」ボタンを追加
   - 2人の利用者を順番にクリックして入れ替え

**メリット:**
- ✅ 一度の操作で入れ替え完了
- ✅ 未割り当てに戻す手間が不要
- ✅ 直感的

**デメリット:**
- 実装がやや複雑

#### 代替案: 一時的な定員オーバー許可

**実装内容:**
- 定員オーバー時に警告を表示するが、操作は許可
- 「定員オーバー」の視覚的な警告（赤色表示）
- 保存時に最終チェック

**メリット:**
- ✅ 柔軟な操作が可能
- ✅ 実装が簡単

**デメリット:**
- ❌ 定員オーバーのまま保存される可能性

## 優先順位

### 🔴 最優先（今すぐ使えるようにするため）
1. **問題1: 新規登録後の未割り当て反映**
   - days_of_week形式の問題を完全に解決
   - 自動反映 + 手動同期ボタンを実装

### 🟡 次の優先度
2. **問題2: 地図表示の番号重複**
   - マーカー完全クリア + 再描画を実装

3. **問題3: 車両間移動時の定員オーバー**
   - スワップ機能を実装

## 推奨される実装順序

1. **問題1の根本原因を解決**
   - days_of_week形式の問題を本番環境で解決
   - Vercelの手動再デプロイ

2. **問題1の補助機能を追加**
   - 手動同期ボタンを実装
   - トースト通知を実装

3. **問題2を解決**
   - 地図マーカーのクリア処理を改善

4. **問題3を解決**
   - スワップ機能を実装

## 次のアクション

どの問題から取り組みますか？推奨順序は上記の通りですが、ユーザーの優先順位に応じて調整可能です。

