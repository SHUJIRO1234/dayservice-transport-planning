# 全体ビューの問題点詳細分析

## 1. ドロップ失敗時の挙動

### 問題
- 青い表示（ドロップゾーン）を探してドロップしなければならない
- 青くない場所にドロップすると利用者が消える

### 原因
`handleDragEnd` で `targetType` が特定できない場合、`return` で処理を中断しているが、その前に元の場所から削除してしまっている可能性。

### 修正方針
- ターゲットが特定できない場合は、何もせずに終了（元の場所に残す）
- 現在の実装を確認し、削除処理の順序を見直す

## 2. 特定の車両にドロップできない

### 問題
- 月曜日の3号車、5号車にドロップできない（青くならない）
- 2便には移動できる

### 原因の可能性
1. **車両が無効になっている**: `isActive: false` の車両は表示されない
2. **便が作成されていない**: 自動割り当てを実行していない車両には便がない
3. **DashboardViewの表示条件**: `activeVehicles` のみ表示している

### 確認事項
- 3号車、5号車の `isActive` 状態
- 3号車、5号車に便が作成されているか
- DashboardViewの表示ロジック

## 3. 定員オーバーの問題

### 問題
- 6人乗りに7人表示される
- 自動的に2便に移動してほしい

### 原因
- 手動でのドラッグ&ドロップ時に定員チェックをしていない

### 修正方針
- `handleDragEnd` で定員チェックを追加
- 定員オーバーの場合は以下の選択肢：
  1. ドロップを拒否（元の場所に戻す）
  2. 自動的に次の便を作成して移動
  3. アラートを表示して確認

**推奨**: オプション1（ドロップ拒否）+ アラート表示

## 4. ドロップゾーンの混同

### 問題
- 同じ車両内の入れ替えと、車両へのドロップが混同される

### 原因
- SortableContextが便ごとに設定されているため、利用者カード自体がドロップゾーンになっている
- VehicleTripDropZoneと利用者カードの両方が反応している

### 修正方針
- ドロップゾーンの優先順位を明確にする
- 空のエリアにドロップした場合のみ、便に追加
- 利用者カードにドロップした場合は、順序入れ替えとして処理

## 5. データの永続化

### 問題
- 曜日を切り替えると、前の曜日の変更が失われる

### 原因
- 現在の実装では、曜日を切り替えるたびに `weeklyData` から初期化している
- 変更内容がメモリ上にしか保存されていない

### 修正方針（段階的実装）

#### Phase 1: ローカルストレージに保存（即座に実装可能）
```javascript
// 変更時に自動保存
useEffect(() => {
  localStorage.setItem(`assignments_${selectedWeekday}`, JSON.stringify(vehicleAssignments))
}, [vehicleAssignments, selectedWeekday])

// 読み込み時に復元
useEffect(() => {
  const saved = localStorage.getItem(`assignments_${selectedWeekday}`)
  if (saved) {
    setVehicleAssignments(JSON.parse(saved))
  }
}, [selectedWeekday])
```

#### Phase 2: データベース連携（将来の実装）
- Supabase、Firebase、またはバックエンドAPIを使用
- ユーザーごとのデータ管理
- シフト確定機能（編集ロック）

#### Phase 3: シフト確定機能
- 「確定」ボタンを追加
- 確定後は編集不可（または警告表示）
- 確定解除機能

